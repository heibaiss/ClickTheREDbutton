<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤§çº¢æŒ‰é’®é…ç½®å™¨</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: inline-block; max-width: 450px; }
        #canvas-container { width: 200px; height: 200px; margin: 0 auto 20px; }
        h1 { color: #d32f2f; margin-bottom: 10px; }
        button { 
            padding: 12px 25px; font-size: 16px; cursor: pointer; 
            background: #d32f2f; color: white; border: none; 
            border-radius: 50px; margin: 10px; transition: 0.2s;
        }
        button:hover { background: #b71c1c; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; transform: none; }
        input { padding: 10px; font-size: 16px; width: 60px; text-align: center; border: 2px solid #ddd; border-radius: 10px; }
        #status { margin-top: 20px; color: #777; font-size: 14px; border-top: 1px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="canvas-container">
        <lottie-player 
            src="1.json" 
            background="transparent" 
            speed="1" 
            style="width: 100%; height: 100%;" 
            loop 
            autoplay>
        </lottie-player>
    </div>

    <h1>å¤§çº¢æŒ‰é’®é…ç½®</h1>
    
    <button id="connectBtn">ğŸ”Œ è¿æ¥è®¾å¤‡</button>
    
    <div id="controlPanel" style="display:none; margin-top: 20px;">
        <p>è®¾ç½®æŒ‰ä¸‹æŒ‰é’®è¾“å…¥çš„å­—ç¬¦ï¼š</p>
        <input type="text" id="newKeyInput" maxlength="1" value="3">
        <button id="sendBtn">ğŸ’¾ ç¡®è®¤ä¿®æ”¹å¹¶ä¿å­˜</button>
    </div>

    <p id="status">æç¤ºï¼šè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨æ‰“å¼€</p>
</div>

<script>
    let port;
    let writer;

    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const status = document.getElementById('status');
    const controlPanel = document.getElementById('controlPanel');
    const newKeyInput = document.getElementById('newKeyInput');

    // è¿æ¥é€»è¾‘
    connectBtn.addEventListener('click', async () => {
        if (!navigator.serial) {
            status.innerText = "âŒ é”™è¯¯ï¼šä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Serial APIï¼Œè¯·æ¢ç”¨ Chrome æˆ– Edgeã€‚";
            return;
        }

        try {
            status.innerText = "â³ æ­£åœ¨è¯·æ±‚è¿æ¥...";
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            status.innerText = "âœ… è®¾å¤‡å·²è¿æ¥ï¼ç°åœ¨å¯ä»¥ä¿®æ”¹æŒ‰é”®äº†ã€‚";
            connectBtn.disabled = true;
            connectBtn.innerText = "å·²è¿æ¥";
            controlPanel.style.display = "block";
            
            const textEncoder = new TextEncoderStream();
            textEncoder.readable.pipeTo(port.writable);
            writer = textEncoder.writable.getWriter();
        } catch (err) {
            console.error(err);
            status.innerText = "âŒ è¿æ¥å–æ¶ˆæˆ–å¤±è´¥ï¼š" + err.message;
        }
    });

    // å‘é€é€»è¾‘
    sendBtn.addEventListener('click', async () => {
        const charToSend = newKeyInput.value;
        if (!charToSend) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼");
            return;
        }

        if (writer) {
            try {
                status.innerText = "â³ æ­£åœ¨å†™å…¥è®¾å¤‡ EEPROM...";
                await writer.write(charToSend);
                status.innerText = `ğŸ‰ æˆåŠŸï¼æŒ‰é’®å·²ä¿®æ”¹ä¸º: "${charToSend}" (æ‰ç”µä¸ä¸¢å¤±)`;
            } catch (err) {
                status.innerText = "âŒ å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚";
            }
        }
    });
</script>

</body>
</html>
