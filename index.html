<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç‚¹å‡»å¤§çº¢æŒ‰é’®</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 50px; background-color: #f4f4f4; }
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: inline-block; }
        h1 { color: #d32f2f; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #d32f2f; color: white; border: none; border-radius: 5px; margin: 10px; }
        button:disabled { background-color: #ccc; }
        input { padding: 10px; font-size: 16px; width: 50px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        #status { margin-top: 20px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”´ ç‚¹å‡»å¤§çº¢æŒ‰é’®</h1>
    <p>ç¬¬ä¸€æ­¥ï¼šè¿æ¥è®¾å¤‡</p>
    <button id="connectBtn">ğŸ”Œ è¿æ¥æŒ‰é’®è®¾å¤‡</button>
    
    <div id="controlPanel" style="display:none; margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
        <p>ç¬¬äºŒæ­¥ï¼šè¾“å…¥ä½ æƒ³ç»‘å®šçš„æ–°æŒ‰é”®ï¼ˆå•ä¸ªå­—ç¬¦ï¼‰</p>
        <input type="text" id="newKeyInput" maxlength="1" value="3">
        <button id="sendBtn">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
    </div>

    <p id="status">ç­‰å¾…è¿æ¥...</p>
</div>

<script>
    let port;
    let writer;

    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const status = document.getElementById('status');
    const controlPanel = document.getElementById('controlPanel');
    const newKeyInput = document.getElementById('newKeyInput');

    connectBtn.addEventListener('click', async () => {
        try {
            // è¯·æ±‚ä¸²å£æƒé™
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 }); // æ³¢ç‰¹ç‡å¯¹äºè™šæ‹Ÿä¸²å£ä¸é‡è¦ï¼Œä½†å¿…é¡»å¡«
            
            status.innerText = "âœ… å·²è¿æ¥ï¼";
            connectBtn.disabled = true;
            connectBtn.innerText = "å·²è¿æ¥";
            controlPanel.style.display = "block";
            
            // å‡†å¤‡å†™å…¥æµ
            const textEncoder = new TextEncoderStream();
            const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
            writer = textEncoder.writable.getWriter();

        } catch (err) {
            console.error(err);
            status.innerText = "âŒ è¿æ¥å¤±è´¥: " + err;
        }
    });

    sendBtn.addEventListener('click', async () => {
        const charToSend = newKeyInput.value;
        if (!charToSend) return;

        if (writer) {
            try {
                status.innerText = "â³ æ­£åœ¨å‘é€...";
                await writer.write(charToSend);
                status.innerText = `ğŸ‰ æˆåŠŸï¼æŒ‰é’®åŠŸèƒ½å·²ä¿®æ”¹ä¸º: "${charToSend}"`;
            } catch (err) {
                status.innerText = "âŒ å‘é€å¤±è´¥";
            }
        }
    });
</script>

</body>
</html>
